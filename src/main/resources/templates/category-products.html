<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"/>
  <!-- External CSS -->
  <link rel="stylesheet" href="/css/home.css"/>
  
  <!-- Blinkit Cart System -->
  <script src="/js/blinkit-cart.js"></script>
  
  <title th:text="'Products in ' + ${categoryName} + ' Category'">Category Products</title>
  
  <style>
    .category-header {
      background: linear-gradient(135deg, #0c831f 0%, #0a6f1a 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      padding: 0 1rem;
    }
    
    .product-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid #f0f0f0;
      position: relative;
    }
    
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 32px rgba(12, 131, 31, 0.15);
    }
    
    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f8f9fa;
      position: relative;
    }
    
    .delivery-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #0c831f;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .discount-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #ff4444;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .product-info {
      padding: 1.5rem;
    }
    
    .product-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }
    
    .product-unit {
      font-size: 13px;
      color: #666;
      margin-bottom: 0.75rem;
    }
    
    .product-price {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 1.25rem;
    }
    
    .current-price {
      font-size: 18px;
      font-weight: 700;
      color: #0c831f;
    }
    
    .original-price {
      font-size: 14px;
      color: #999;
      text-decoration: line-through;
    }
    
    .product-actions {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-view-details {
      background: #f0f0f0;
      color: #666;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-left: 8px;
    }
    
    .btn-view-details:hover {
      background: #e0e0e0;
      color: #333;
      text-decoration: none;
      transform: translateY(-1px);
    }
    
    .back-button {
      margin-bottom: 1.5rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      color: #ddd;
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        padding: 0 0.5rem;
      }
      
      .product-info {
        padding: 1rem;
      }
      
      .category-header {
        padding: 1.5rem 0;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: #0c831f;">
    <div class="container">
      <a class="navbar-brand" href="/home">
        <i class="fas fa-shopping-basket"></i>
        GroceryStore
      </a>
      
      <div class="navbar-nav ml-auto">
        <a class="nav-link" href="/home">
          <i class="fas fa-home"></i> Home
        </a>
        <a class="nav-link" href="#" onclick="window.history.back()">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
  </nav>

  <!-- Category Header -->
  <div class="category-header mt-5 pt-3">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1 class="text-center mb-2" th:text="${categoryName}">Category Name</h1>
          <p class="text-center mb-0 opacity-75">
            <span id="productCount">Loading...</span> products available â€¢ Fast delivery in 11 minutes
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Back Button -->
    <div class="back-button">
      <a href="/home" class="btn btn-outline-success">
        <i class="fas fa-arrow-left"></i> Back to Home
      </a>
    </div>

    <!-- Loading State -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-success" role="status" style="color: #0c831f !important;">
        <span class="sr-only">Loading products...</span>
      </div>
    </div>

    <!-- Products Grid -->
    <div id="productsGrid" class="product-grid" style="display: none;">
      <!-- Products will be loaded here dynamically -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <i class="fas fa-shopping-basket"></i>
      <h3>No Products Found</h3>
      <p>There are no products available in this category at the moment.</p>
      <a href="/home" class="btn" style="background: #0c831f; color: white;">
        <i class="fas fa-home"></i> Back to Home
      </a>
    </div>
  </div>

  <!-- Footer spacing -->
  <div style="height: 100px;"></div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const categoryName = /*[[${categoryName}]]*/ '';
      console.log('Loading products for category:', categoryName);
      loadCategoryProducts(categoryName);
    });

    function loadCategoryProducts(categoryName) {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const productsGrid = document.getElementById('productsGrid');
      const emptyState = document.getElementById('emptyState');
      const productCount = document.getElementById('productCount');

      // Show loading state
      loadingSpinner.style.display = 'flex';
      productsGrid.style.display = 'none';
      emptyState.style.display = 'none';

      console.log('Fetching products from API for category:', categoryName);
      
      // Create a mapping for better category name matching
      const categoryMapping = {
        'Fruits And Vegetables': ['Fruits', 'Vegetables', 'Fruit', 'Vegetable'],
        'Meat And Fish': ['Meat', 'Fish', 'Meats'],
        'Dairy and chilled': ['Dairy', 'Milk', 'Cheese'],
        'Bread And Tortilas': ['Bakery', 'Bread', 'Tortillas'],
        'Drinks': ['Beverages', 'Drink', 'Juice'],
        'Baby & Child': ['Baby', 'Child', 'Kids'],
        'Cosmetics': ['Personal Care', 'Beauty', 'Cosmetics'],
        'Pharmacy': ['Health', 'Medicine', 'Pharmacy'],
        'Pets': ['Pet', 'Animal'],
        'Packaged': ['Snacks', 'Packaged'],
        'Frozen': ['Frozen'],
        'Meats And Salami': ['Salami', 'Deli']
      };
      
      // Find the best matching database category name
      let bestMatch = categoryName;
      for (const [dbCategory, aliases] of Object.entries(categoryMapping)) {
        if (dbCategory.toLowerCase() === categoryName.toLowerCase() ||
            aliases.some(alias => alias.toLowerCase() === categoryName.toLowerCase() ||
                                 categoryName.toLowerCase().includes(alias.toLowerCase()) ||
                                 alias.toLowerCase().includes(categoryName.toLowerCase()))) {
          bestMatch = dbCategory;
          break;
        }
      }
      
      console.log('Using mapped category name:', bestMatch);
      
      // Now fetch products for the category
      fetch(`/products/api/category/${encodeURIComponent(bestMatch)}`)
        .then(response => {
          console.log('Products API Response status:', response.status);
          if (!response.ok) {
            throw new Error('Failed to fetch products');
          }
          return response.json();
        })
        .then(products => {
          console.log('Received products:', products);
          
          loadingSpinner.style.display = 'none';
          
          if (!products || products.length === 0) {
            emptyState.style.display = 'block';
            productCount.textContent = '0';
          } else {
            productCount.textContent = products.length;
            renderProducts(products);
            productsGrid.style.display = 'grid';
          }
        })
        .catch(error => {
          console.error('Error fetching products:', error);
          loadingSpinner.style.display = 'none';
          emptyState.style.display = 'block';
          productCount.textContent = '0';
        });
    }

    function renderProducts(products) {
      const productsGrid = document.getElementById('productsGrid');
      
      const productsHtml = products.map((product, index) => {
        const imageUrl = product.imageUrl || '/images/default-product.png';
        const price = product.price || product.discountedPrice || 0;
        const originalPrice = product.originalPrice || (product.discountedPrice ? product.price : null);
        const hasDiscount = originalPrice && originalPrice > price;
        const discountPercent = hasDiscount ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
        
        // Generate unique product ID if not available
        const productId = product.id || `product-${index}`;
        const unit = product.unit || '1 unit';
        
        return `
          <div class="product-card">
            <div class="product-image">
              <img src="${imageUrl}" alt="${product.name}" 
                   style="width: 100%; height: 100%; object-fit: cover;"
                   onerror="this.src='/images/default-product.png'">
              
              ${hasDiscount ? `<div class="discount-badge">${discountPercent}% OFF</div>` : ''}
              <div class="delivery-badge">11 min</div>
            </div>
            
            <div class="product-info">
              <h5 class="product-name">${product.name}</h5>
              <div class="product-unit">${unit}</div>
              
              <div class="product-price">
                <span class="current-price">â‚¹${price.toFixed(0)}</span>
                ${hasDiscount ? `<span class="original-price">â‚¹${originalPrice.toFixed(0)}</span>` : ''}
              </div>
              
              <div class="product-actions">
                <button class="blinkit-add-btn" 
                        data-product-id="${productId}"
                        data-product-name="${product.name.replace(/"/g, '&quot;')}"
                        data-price="${price}"
                        data-image="${imageUrl}"
                        data-unit="${unit}"
                        onclick="blinkitCart.addToCart('${productId}')">
                  ADD
                </button>
                <a href="/products/${productId}" class="btn-view-details">
                  <i class="fas fa-eye"></i> Details
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      productsGrid.innerHTML = productsHtml;
      
      // Update cart buttons after rendering
      setTimeout(() => {
        if (typeof blinkitCart !== 'undefined') {
          blinkitCart.updateProductButtons();
        }
      }, 100);
    }
  </script>
</body>
</html>