<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${categoryName + ' - Category Shopping'}">Category Shopping</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    
 
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fafafa;
            margin: 0;
            padding: 0;
        }

        /* Modern Category Navigation inspired by entry.html */
        .category-menu-bar {
            background: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 10000; /* Increased from 1000 to ensure it's above other elements */
            margin-bottom: 20px;
            padding: 0;
            overflow: visible; /* Changed from hidden to visible for dropdowns */
        }
        
        .category-menu-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none; /* Hide scrollbar for IE and Edge */
        }
        
        .category-menu-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        
        .category-menu {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: nowrap;
            padding: 0;
            margin: 0;
            list-style: none;
            min-height: 60px;
            min-width: max-content; /* Ensure menu doesn't compress */
            gap: 4px; /* Add small gap between items */
        }
        
        .category-menu-item {
            position: relative;
            margin: 0;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: auto; /* Allow natural sizing */
        }
        
        .category-menu-item:hover {
            z-index: 10002; /* Increased z-index */
        }
        
        .category-menu-link {
            display: flex;
            align-items: center;
            padding: 18px 12px; /* Slightly reduced horizontal padding */
            color: #212121;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 6px;
            white-space: nowrap;
            min-width: fit-content;
        }
        
        .category-menu-link:hover {
            color: #333;
            text-decoration: none;
            background: #f8f9fa;
        }
        
        .category-menu-item.active .category-menu-link {
            color: #333;
            background: #f8f9fa;
            font-weight: 600;
        }
        
        /* Modern Mega Dropdown inspired by entry.html */
        .mega-dropdown {
            position: absolute;
            top: 100%;
            left: -20px; /* Extend beyond the parent */
            right: -20px; /* Extend beyond the parent */
            background: white;
            border: 1px solid #f0f0f0;
            border-top: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            
            /* Start hidden */
            display: none !important; /* Force hide initially */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            pointer-events: none;
            
            /* Enhanced dropdown styling */
            min-height: 200px;
            max-height: 450px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 0 0 12px 12px;
            width: auto;
            min-width: 600px;
        }
        
        /* Force show dropdown on hover - simplified approach */
        .category-menu-item:hover .mega-dropdown {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            z-index: 10001 !important;
        }
        
        /* Keep dropdown visible when hovering over it */
        .mega-dropdown:hover {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            z-index: 10001 !important;
        }
        
        .category-menu-item:hover .mega-dropdown {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            z-index: 10001 !important;
        }
        
        .category-menu-item .mega-dropdown:hover {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            z-index: 10001 !important;
        }
        
        /* Ensure dropdown shows immediately on hover */
        .category-menu-item:hover > .mega-dropdown,
        .mega-dropdown:hover {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            z-index: 10001 !important;
        }
        
        .mega-dropdown-content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            max-width: 1600px;
            margin: 0 auto;
            padding: 25px 30px;
            gap: 30px;
            flex-wrap: wrap;
            overflow: hidden;
        }
        
        .dropdown-section {
            flex: 1 1 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 250px;
            max-width: 400px;
        }
        
        .subcategory-grid {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
            padding-top: 15px;
        }
        
        .subcategory-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px;
            flex: 1;
        }
        
        .subcategory-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .subcategory-item {
            margin-bottom: 4px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .subcategory-link {
            display: block;
            padding: 8px 15px;
            color: #212121;
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
            transition: all 0.2s ease;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 140px;
        }
        
        .subcategory-link:hover {
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
        }

        /* Header Styles */
        .category-header {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 16px 0;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .breadcrumb-nav a {
            color: #0c831f;
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-nav a:hover {
            color: #0a6e1a;
        }

        .category-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-title i {
            color: #0c831f;
            font-size: 20px;
        }

        /* Blinkit-Style Shopping Cart Container */
        .blinkit-cart-container {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #0c831f;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: white;
            font-weight: 600;
            font-size: 14px;
            min-width: 120px;
            justify-content: center;
        }

        .blinkit-cart-container:hover {
            background: #0a6e1a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(12, 131, 31, 0.3);
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #ff3333;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid white;
        }

        .blinkit-cart-button {
            background: none;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Layout */
        .category-shopping-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 0;
            min-height: calc(100vh - 80px);
        }

        /* Left Sidebar - Subcategories */
        .subcategories-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #f0f0f0;
            padding: 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #e0e0e0 transparent;
        }

        .subcategories-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .subcategories-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .subcategories-sidebar::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 3px;
        }

        .subcategories-sidebar::-webkit-scrollbar-thumb:hover {
            background: #d0d0d0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-title i {
            color: #0c831f;
            font-size: 14px;
        }

        .subcategories-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .subcategory-item {
            border-bottom: 1px solid #f8f8f8;
        }

        .subcategory-link {
            display: block;
            padding: 16px 20px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            border-left: 4px solid transparent;
        }

        .subcategory-link:hover {
            background: #f8fdf9;
            color: #0c831f;
            text-decoration: none;
            border-left-color: #0c831f;
        }

        .subcategory-link.active {
            background: #f0f9f1;
            color: #0c831f;
            font-weight: 600;
            border-left-color: #0c831f;
        }

        .subcategory-link.active::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: #0c831f;
            border-radius: 50%;
        }

        .subcategory-product-count {
            background: #e8f5e8;
            color: #0c831f;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            display: inline-block;
        }

        /* Main Content Area */
        .products-content {
            flex: 1;
            padding: 20px;
            background: #fafafa;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }

        .subcategory-info h2 {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin: 0;
            margin-bottom: 4px;
        }

        .subcategory-description {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .product-count-badge {
            background: #0c831f;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Blinkit-Style Product Grid */
        .blinkit-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            padding: 0;
        }

        .blinkit-product-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .blinkit-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: #e0e0e0;
        }

        .product-image-container {
            position: relative;
            height: 180px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .blinkit-product-card:hover .product-image {
            transform: scale(1.05);
        }

        .delivery-time-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(12, 131, 31, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .discount-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        .product-details {
            padding: 16px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-weight {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }

        .product-pricing {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .current-price {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .original-price {
            font-size: 14px;
            color: #999;
            text-decoration: line-through;
        }

        .savings-amount {
            font-size: 12px;
            color: #0c831f;
            font-weight: 600;
            background: #e8f5e8;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Blinkit-Style Add Button */
        .blinkit-add-button {
            width: 100%;
            padding: 8px 12px;
            background: #0c831f;
            color: white;
            border: 1px solid #0c831f;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
        }

        .blinkit-add-button:hover {
            background: #0a6e1a;
            border-color: #0a6e1a;
            transform: translateY(-1px);
        }

        .blinkit-add-button:active {
            transform: translateY(0);
        }

        /* Quantity Controls */
        .product-quantity-controls {
            display: none;
            width: 100%;
            align-items: center;
            background: #0c831f;
            border-radius: 8px;
            padding: 4px;
            gap: 0;
        }

        .product-quantity-controls.show {
            display: flex;
        }

        .product-qty-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            padding: 4px 8px;
            transition: all 0.2s ease;
            flex: 0 0 auto;
        }

        .product-qty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .product-qty-value {
            flex: 1;
            text-align: center;
            color: white;
            font-weight: 700;
            font-size: 13px;
            padding: 4px;
        }

        /* Empty State */
        .empty-products {
            text-align: center;
            padding: 80px 20px;
            color: #666;
            background: white;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }

        .empty-products i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-products h3 {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .empty-products p {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        /* Loading State */
        .loading-products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            padding: 0;
        }

        .product-skeleton {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .skeleton-image {
            height: 180px;
            background: #f0f0f0;
        }

        .skeleton-content {
            padding: 16px;
        }

        .skeleton-line {
            height: 16px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 70%;
        }

        .skeleton-line.medium {
            width: 85%;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Shopping Cart Modal */
        .cart-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            right: 20px;
            top: 90px;
            width: 380px;
            max-height: 80vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
        }

        .cart-modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 80vh;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            border-radius: 12px 12px 0 0;
        }

        .cart-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cart-header h3 i {
            color: #0c831f;
            font-size: 16px;
        }

        .close-cart {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .close-cart:hover {
            color: #333;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            max-height: 400px;
            min-height: 200px;
        }

        .cart-footer {
            border-top: 1px solid #f0f0f0;
            padding: 16px 20px;
            background: #fafafa;
            border-radius: 0 0 12px 12px;
        }

        .cart-summary {
            margin-bottom: 16px;
        }

        .cart-total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .cart-actions {
            display: flex;
            gap: 8px;
        }

        .cart-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cart-btn-secondary {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .cart-btn-secondary:hover {
            background: #f8f8f8;
        }

        .cart-btn-primary {
            background: #0c831f;
            color: white;
        }

        .cart-btn-primary:hover {
            background: #0a6e1a;
        }

        /* Debug border for dropdowns */
        .mega-dropdown.debug-visible {
            border: 3px solid red !important;
            background: rgba(255, 255, 0, 0.1) !important;
        }
        
        /* Remove duplicate CSS rules and create a clean hover system */
        /* Responsive Design */
        @media (max-width: 768px) {
            .category-shopping-container {
                flex-direction: column;
            }

            .subcategories-sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid #f0f0f0;
            }

            .subcategories-list {
                display: flex;
                overflow-x: auto;
                padding: 0 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .subcategories-list::-webkit-scrollbar {
                display: none;
            }

            .subcategory-item {
                border-bottom: none;
                border-right: 1px solid #f8f8f8;
                flex-shrink: 0;
            }

            .subcategory-item:last-child {
                border-right: none;
            }

            .subcategory-link {
                white-space: nowrap;
                padding: 12px 16px;
                border-left: none;
                border-bottom: 4px solid transparent;
            }

            .subcategory-link:hover,
            .subcategory-link.active {
                border-left: none;
                border-bottom-color: #0c831f;
            }

            .blinkit-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
            }

            .header-content {
                padding: 0 15px;
            }

            .category-title {
                font-size: 20px;
            }

            .products-content {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .blinkit-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .subcategory-info h2 {
                font-size: 18px;
            }

            .product-count-badge {
                align-self: flex-end;
            }
        }

        /* Loading Animation */
        .loading-menu {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #878787;
            font-size: 14px;
        }
        
        .loading-menu i {
            animation: spin 1s linear infinite;
            margin-right: 8px;
            color: #2874f0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Modern Category Navigation Bar -->
    <div class="category-menu-bar">
        <div class="category-menu-container">
            <ul class="category-menu" id="categoryMenu">
                <li class="loading-menu">
                    <i class="fas fa-spinner"></i> Loading categories...
                </li>
            </ul>
        </div>
    </div>



    <!-- Header -->
    <div class="category-header">
        <div class="header-content">
            <div class="header-left">
                <div class="breadcrumb-nav">
                    <a href="/home"><i class="fas fa-home"></i> Home</a>
                    <i class="fas fa-chevron-right"></i>
                    <span th:text="${categoryName}">Category</span>
                </div>
                <h1 class="category-title">
                    <i class="fas fa-th-large"></i>
                    <span th:text="${categoryName}">Category Shopping</span>
                </h1>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="category-shopping-container">
        <!-- Left Sidebar - Subcategories -->
        <div class="subcategories-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">
                    <i class="fas fa-list"></i>
                    Browse Categories
                </h3>
            </div>
            <ul class="subcategories-list" id="subcategoriesList">
                <!-- Subcategories will be loaded here -->
                <li class="subcategory-item">
                    <div class="subcategory-link">
                        <i class="fas fa-spinner fa-spin"></i> Loading categories...
                    </div>
                </li>
            </ul>
        </div>

        <!-- Main Content - Products -->
        <div class="products-content">
            <div class="content-header">
                <div class="subcategory-info">
                    <h2 id="subcategoryName">Select a Category</h2>
                    <p class="subcategory-description" id="subcategoryDescription">
                        Choose a category from the left sidebar to view products
                    </p>
                </div>
                <div class="product-count-badge" id="productCountBadge" style="display: none;">
                    <i class="fas fa-box"></i>
                    <span id="productCount">0</span> Products
                </div>
            </div>

            <!-- Products Grid -->
            <div class="blinkit-products-grid" id="productsGrid">
                <!-- Products will be dynamically inserted here -->
            </div>
            
            <!-- Loading state -->
            <div class="loading-products" id="loadingProducts" style="display: none;">
                <div class="product-skeleton" th:each="i : ${#numbers.sequence(1, 8)}">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line"></div>
                    </div>
                </div>
            </div>
            
            <!-- Empty state -->
            <div class="empty-products" id="emptyProducts" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h3>No Products Found</h3>
                <p>There are no products available in this category at the moment.</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    

    
    <script>
        // Global variables
        let allCategories = [];
       // let allCategoriesForMenu = [];
        let currentCategoryId = null;
        let currentSubcategoryId = null;

        // Get category and subcategory IDs from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentCategoryId = urlParams.get('categoryId');
        currentSubcategoryId = urlParams.get('subcategoryId');

        console.log('Category page loaded with:', { currentCategoryId, currentSubcategoryId });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Category shopping page DOM loaded');
            loadCategoriesAndSubcategories();
            loadCategoriesForMenu();
        });

        // Category Navigation Menu Functions
        let allCategoriesForMenu = [];

        // Load all categories with their subcategories for navigation menu
        async function loadCategoriesForMenu() {
            console.log('Starting to load categories for navigation menu...');
            
            const endpoints = [
                '/api/categories/with-subcategories',
                window.location.origin + '/api/categories/with-subcategories'
            ];
            
            for (let endpoint of endpoints) {
                try {
                    console.log('Menu navigation trying endpoint:', endpoint);
                    const response = await fetch(endpoint);
                    console.log('Menu navigation response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error('HTTP error! status: ' + response.status + ', message: ' + errorText);
                    }
                    
                    const data = await response.json();
                    console.log('Menu navigation received data:', data);
                    allCategoriesForMenu = data;
                    
                    if (!data || data.length === 0) {
                        console.log('No categories found for navigation menu');
                        document.getElementById('categoryMenu').innerHTML = 
                            '<li style="padding: 20px; color: #666;">No categories available</li>';
                        return;
                    }
                    
                    renderCategoryNavigationMenu();
                    return; // Success, exit the loop
                } catch (error) {
                    console.error('Menu navigation error with endpoint', endpoint, ':', error);
                    if (endpoint === endpoints[endpoints.length - 1]) {
                        // Last endpoint failed - show error
                        document.getElementById('categoryMenu').innerHTML = 
                            '<li style="padding: 20px, color: #dc3545;">' +
                            '<i class="fas fa-exclamation-triangle"></i> Error loading menu: ' + error.message + 
                            '</li>';
                    }
                }
            }
        }

        // Render the category navigation menu (same as entry.html)
        function renderCategoryNavigationMenu() {
            console.log('Rendering category navigation menu with', allCategoriesForMenu.length, 'categories');
            
            if (!allCategoriesForMenu || allCategoriesForMenu.length === 0) {
                document.getElementById('categoryMenu').innerHTML = 
                    '<li class="loading-menu">No categories available</li>';
                return;
            }
            
            try {
                const menuHtml = allCategoriesForMenu.map((category, index) => {
                    console.log('Processing category for menu:', category.name, 'with', category.subcategories ? category.subcategories.length : 'NO SUBCATEGORIES', 'subcategories');
                    
                    // Check if subcategories exist and are an array
                    if (!category.subcategories || !Array.isArray(category.subcategories)) {
                        category.subcategories = [];
                    }
                    
                    // Create subcategory sections
                    const subcategorySections = [];
                    
                    if (category.subcategories.length > 0) {
                        // Calculate optimal columns based on subcategory count
                        const subcategoryCount = category.subcategories.length;
                        let columnsCount = 1;
                        
                        if (subcategoryCount > 15) columnsCount = 4;
                        else if (subcategoryCount > 10) columnsCount = 3;
                        else if (subcategoryCount > 5) columnsCount = 2;
                        
                        const itemsPerColumn = Math.ceil(subcategoryCount / columnsCount);
                        
                        // Create columns
                        const columns = [];
                        for (let i = 0; i < columnsCount; i++) {
                            const startIndex = i * itemsPerColumn;
                            const endIndex = Math.min(startIndex + itemsPerColumn, subcategoryCount);
                            columns.push(category.subcategories.slice(startIndex, endIndex));
                        }
                        
                        // Generate subcategories HTML
                        const columnsHtml = columns.map((columnItems) => {
                            const subcategoriesHtml = columnItems.map((subcategory) => {
                                return '<li class="subcategory-item">' +
                                    '<a href="/categories/shopping?categoryId=' + category.id + '&categoryName=' + encodeURIComponent(category.name) + '&subcategoryId=' + subcategory.id + '&subcategoryName=' + encodeURIComponent(subcategory.name) + '" ' +
                                       'class="subcategory-link" title="' + subcategory.name + '">' +
                                        subcategory.name +
                                    '</a>' +
                                '</li>';
                            }).join('');
                            
                            return '<div class="subcategory-column">' +
                                    '<ul class="subcategory-list">' +
                                        subcategoriesHtml +
                                    '</ul>' +
                                '</div>';
                        }).join('');
                        
                        subcategorySections.push('<div class="dropdown-section">' +
                                '<div class="subcategory-grid">' +
                                    columnsHtml +
                                '</div>' +
                            '</div>'
                        );
                    }
                    
                    const categoryHtml = '<li class="category-menu-item" data-category-index="' + index + '">' +
                            '<a href="#" class="category-menu-link">' +
                                category.name +
                            '</a>' +
                            '<div class="mega-dropdown" data-dropdown-for="' + index + '">' +
                                '<div class="mega-dropdown-content">' +
                                    subcategorySections.join('') +
                                '</div>' +
                            '</div>' +
                        '</li>';
                    
                    return categoryHtml;
                }).join('');
                
                console.log('Setting innerHTML for category navigation menu');
                document.getElementById('categoryMenu').innerHTML = menuHtml;
                console.log('Category navigation menu rendered successfully');
                
                // Setup hover interactions (same as entry.html)
                setTimeout(() => {
                    setupMenuHoverInteractions();
                }, 100);
                
            } catch (error) {
                console.error('Error rendering category navigation menu:', error);
                document.getElementById('categoryMenu').innerHTML = 
                    '<li class="loading-menu"><i class="fas fa-exclamation-triangle"></i> Error rendering menu</li>';
            }
        }

        // Setup hover interactions for navigation menu (same as entry.html)
        function setupMenuHoverInteractions() {
            const categoryItems = document.querySelectorAll('.category-menu-item');
            console.log('Setting up hover interactions for', categoryItems.length, 'menu categories');
            
            categoryItems.forEach((item, index) => {
                const dropdown = item.querySelector('.mega-dropdown');
                const categoryLink = item.querySelector('.category-menu-link');
                
                if (!dropdown) {
                    console.log('No dropdown found for category item:', index);
                    return;
                }
                
                console.log('Setting up hover for category:', item.textContent.trim(), 'with dropdown:', dropdown);
                
                let hoverTimeout;
                
                // Show dropdown on mouseenter
                item.addEventListener('mouseenter', function(e) {
                    console.log('Mouse enter on category:', item.textContent.trim());
                    clearTimeout(hoverTimeout);
                    dropdown.style.display = 'block';
                    dropdown.style.opacity = '1';
                    dropdown.style.visibility = 'visible';
                    dropdown.style.transform = 'translateY(0)';
                    dropdown.style.pointerEvents = 'auto';
                    dropdown.style.zIndex = '10001';
                });
                
                // Hide dropdown on mouseleave with delay
                item.addEventListener('mouseleave', function(e) {
                    console.log('Mouse leave from category:', item.textContent.trim());
                    hoverTimeout = setTimeout(() => {
                        if (!dropdown.matches(':hover') && !item.matches(':hover')) {
                            dropdown.style.opacity = '0';
                            dropdown.style.visibility = 'hidden';
                            dropdown.style.transform = 'translateY(-10px)';
                            dropdown.style.pointerEvents = 'none';
                        }
                    }, 150);
                });
                
                // Keep visible when hovering dropdown
                dropdown.addEventListener('mouseenter', function() {
                    console.log('Mouse enter on dropdown for category:', item.textContent.trim());
                    clearTimeout(hoverTimeout);
                    dropdown.style.display = 'block';
                    dropdown.style.opacity = '1';
                    dropdown.style.visibility = 'visible';
                    dropdown.style.transform = 'translateY(0)';
                    dropdown.style.pointerEvents = 'auto';
                });
                
                dropdown.addEventListener('mouseleave', function() {
                    console.log('Mouse leave from dropdown for category:', item.textContent.trim());
                    dropdown.style.opacity = '0';
                    dropdown.style.visibility = 'hidden';
                    dropdown.style.transform = 'translateY(-10px)';
                    dropdown.style.pointerEvents = 'none';
                });
            });
            
            console.log('Menu hover interactions setup complete');
        }

        // Load categories and subcategories
        async function loadCategoriesAndSubcategories() {
            console.log('Loading categories and subcategories...');
            
            try {
                const response = await fetch('/api/categories/with-subcategories');
                
                if (!response.ok) {
                    throw new Error('Failed to load categories: ' + response.status);
                }
                
                const data = await response.json();
                console.log('Loaded categories:', data);
                
                allCategories = data;
                renderSubcategoriesSidebar();
                
                // If we have a specific subcategory, load its products
                if (currentSubcategoryId) {
                    console.log('Loading products for initial subcategory:', currentSubcategoryId);
                    // Also try to get the subcategory name from URL params for the header
                    const subcategoryName = urlParams.get('subcategoryName') || 'Selected Category';
                    
                    // Update header with subcategory info
                    const subcategoryNameElement = document.getElementById('subcategoryName');
                    const subcategoryDescElement = document.getElementById('subcategoryDescription');
                    
                    if (subcategoryNameElement) {
                        subcategoryNameElement.textContent = decodeURIComponent(subcategoryName);
                    }
                    if (subcategoryDescElement) {
                        subcategoryDescElement.textContent = `Fresh products from ${decodeURIComponent(subcategoryName)} category`;
                    }
                    
                    loadProductsBySubcategory(currentSubcategoryId);
                } else if (currentCategoryId) {
                    // Auto-load first subcategory's products when no specific subcategory is selected
                    console.log('No subcategory specified, auto-loading first subcategory for category:', currentCategoryId);
                    
                    const currentCategory = allCategories.find(category => category.id === currentCategoryId);
                    if (currentCategory && currentCategory.subcategories && currentCategory.subcategories.length > 0) {
                        const firstSubcategory = currentCategory.subcategories[0];
                        console.log('Auto-loading first subcategory:', firstSubcategory.name);
                        
                        // Set the current subcategory ID
                        currentSubcategoryId = firstSubcategory.id;
                        
                        // Update header with first subcategory info
                        const subcategoryNameElement = document.getElementById('subcategoryName');
                        const subcategoryDescElement = document.getElementById('subcategoryDescription');
                        
                        if (subcategoryNameElement) {
                            subcategoryNameElement.textContent = firstSubcategory.name;
                        }
                        if (subcategoryDescElement) {
                            subcategoryDescElement.textContent = `Fresh products from ${firstSubcategory.name} category`;
                        }
                        
                        // Load products for the first subcategory
                        loadProductsBySubcategory(firstSubcategory.id);
                        
                        // Update URL to include the auto-selected subcategory
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('subcategoryId', firstSubcategory.id);
                        newUrl.searchParams.set('subcategoryName', encodeURIComponent(firstSubcategory.name));
                        window.history.replaceState({}, '', newUrl);
                        
                        // Also update the active state in the sidebar
                        setTimeout(() => {
                            const targetElement = document.querySelector(`[data-subcategory-id="${firstSubcategory.id}"]`);
                            if (targetElement) {
                                targetElement.classList.add('active');
                                console.log('Auto-activated first subcategory element:', targetElement);
                            }
                        }, 100);
                        
                    } else {
                        console.log('No subcategories found for category:', currentCategoryId);
                        showEmptyState();
                    }
                } else {
                    console.log('No category or subcategory specified, showing empty state');
                    // Show empty state
                    showEmptyState();
                }
                
            } catch (error) {
                console.error('Error loading categories:', error);
                showErrorState();
            }
        }

        // Render subcategories sidebar
        function renderSubcategoriesSidebar() {
            const subcategoriesList = document.getElementById('subcategoriesList');
            
            if (!subcategoriesList) {
                console.error('Subcategories list element not found in DOM!');
                return;
            }
            
            if (!allCategories || allCategories.length === 0) {
                subcategoriesList.innerHTML = '<li class="subcategory-item"><div class="subcategory-link">No categories available</div></li>';
                return;
            }

            let subcategoriesHtml = '';
            let subcategoryCount = 0;
            
            // Only show subcategories for the current category
            if (currentCategoryId) {
                const currentCategory = allCategories.find(category => category.id === currentCategoryId);
                console.log('Found current category:', currentCategory);
                
                if (currentCategory && currentCategory.subcategories && currentCategory.subcategories.length > 0) {
                    currentCategory.subcategories.forEach(subcategory => {
                        const isActive = subcategory.id == currentSubcategoryId ? 'active' : '';
                        subcategoriesHtml += `
                            <li class="subcategory-item">
                                <a href="#" class="subcategory-link ${isActive}" 
                                   data-subcategory-id="${subcategory.id}"
                                   data-subcategory-name="${subcategory.name}">
                                    ${subcategory.name}
                                    <span class="subcategory-product-count">${subcategory.productCount || 0}</span>
                                </a>
                            </li>
                        `;
                        subcategoryCount++;
                    });
                } else {
                    subcategoriesHtml = '<li class="subcategory-item"><div class="subcategory-link">No subcategories available for this category</div></li>';
                }
            } else {
                console.log('No current category ID specified');
                
                // If we have a subcategoryId but no categoryId, try to find the category that contains this subcategory
                if (currentSubcategoryId) {
                    console.log('Trying to find category for subcategory:', currentSubcategoryId);
                    let foundCategory = null;
                    
                    for (const category of allCategories) {
                        if (category.subcategories && category.subcategories.length > 0) {
                            const foundSubcategory = category.subcategories.find(sub => sub.id == currentSubcategoryId);
                            if (foundSubcategory) {
                                foundCategory = category;
                                currentCategoryId = category.id; // Update the current category ID
                                console.log('Found category for subcategory:', { categoryId: category.id, categoryName: category.name });
                                break;
                            }
                        }
                    }
                    
                    if (foundCategory && foundCategory.subcategories) {
                        // Show only subcategories from the found category
                        foundCategory.subcategories.forEach(subcategory => {
                            const isActive = subcategory.id == currentSubcategoryId ? 'active' : '';
                            subcategoriesHtml += `
                                <li class="subcategory-item">
                                    <a href="#" class="subcategory-link ${isActive}" 
                                       data-subcategory-id="${subcategory.id}"
                                       data-subcategory-name="${subcategory.name}">
                                        ${subcategory.name}
                                        <span class="subcategory-product-count">${subcategory.productCount || 0}</span>
                                    </a>
                                </li>
                            `;
                            subcategoryCount++;
                        });
                    } else {
                        subcategoriesHtml = '<li class="subcategory-item"><div class="subcategory-link">Subcategory not found in any category</div></li>';
                    }
                } else {
                    // No categoryId and no subcategoryId - show message to select a category
                    subcategoriesHtml = '<li class="subcategory-item"><div class="subcategory-link">Please select a category to view subcategories</div></li>';
                }
            }

            if (subcategoriesHtml === '') {
                subcategoriesHtml = '<li class="subcategory-item"><div class="subcategory-link">No subcategories available</div></li>';
            }

            subcategoriesList.innerHTML = subcategoriesHtml;
            console.log('Rendered subcategories sidebar:', {
                categoryId: currentCategoryId,
                subcategoryCount: subcategoryCount,
                currentSubcategoryId: currentSubcategoryId
            });
            
            // Setup event delegation for subcategory clicks
            setupSubcategoryClickHandlers();
            
            // Verify the active subcategory is properly highlighted
            if (currentSubcategoryId) {
                setTimeout(() => {
                    const activeElement = document.querySelector(`[data-subcategory-id="${currentSubcategoryId}"]`);
                    if (activeElement) {
                        console.log('Found and will highlight active subcategory:', activeElement);
                        activeElement.classList.add('active');
                    } else {
                        console.error('Could not find active subcategory element for ID:', currentSubcategoryId);
                    }
                }, 100);
            }
        }
        
        // Setup event delegation for subcategory clicks
        function setupSubcategoryClickHandlers() {
            const subcategoriesList = document.getElementById('subcategoriesList');
            if (!subcategoriesList) {
                console.error('Subcategories list element not found!');
                return;
            }
            
            // Remove any existing event listeners to prevent duplicates
            subcategoriesList.removeEventListener('click', handleSubcategoryClick);
            
            // Add the new event listener
            subcategoriesList.addEventListener('click', handleSubcategoryClick);
            
            console.log('Subcategory click handlers set up successfully');
        }
        
        // Handle subcategory click events
        function handleSubcategoryClick(event) {
            const target = event.target.closest('.subcategory-link');
            if (!target) return;
            
            event.preventDefault();
            
            const subcategoryId = target.dataset.subcategoryId;
            const subcategoryName = target.dataset.subcategoryName;
            
            console.log('Subcategory clicked:', { subcategoryId, subcategoryName, element: target });
            
            if (subcategoryId && subcategoryName) {
                selectSubcategory(subcategoryId, subcategoryName);
            } else {
                console.error('Missing subcategory data:', { 
                    subcategoryId, 
                    subcategoryName, 
                    element: target,
                    dataset: target.dataset 
                });
            }
        }

        // Select subcategory and load products
        function selectSubcategory(subcategoryId, subcategoryName) {
            console.log('Selected subcategory:', { subcategoryId, subcategoryName });
            
            // Update active state
            document.querySelectorAll('.subcategory-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the selected subcategory element
            const targetElement = document.querySelector(`[data-subcategory-id="${subcategoryId}"]`);
            if (targetElement) {
                targetElement.classList.add('active');
                console.log('Activated subcategory element:', targetElement);
            } else {
                console.error('Could not find subcategory element with ID:', subcategoryId);
            }
            
            // Update current subcategory
            currentSubcategoryId = subcategoryId;
            
            // Update header
            const subcategoryNameElement = document.getElementById('subcategoryName');
            const subcategoryDescElement = document.getElementById('subcategoryDescription');
            
            if (subcategoryNameElement) {
                subcategoryNameElement.textContent = subcategoryName;
            }
            if (subcategoryDescElement) {
                subcategoryDescElement.textContent = `Fresh products from ${subcategoryName} category`;
            }
            
            // Load products
            loadProductsBySubcategory(subcategoryId);
            
            // Update URL without page reload
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('subcategoryId', subcategoryId);
            newUrl.searchParams.set('subcategoryName', encodeURIComponent(subcategoryName));
            window.history.pushState({}, '', newUrl);
        }

        // Load products by subcategory
        async function loadProductsBySubcategory(subcategoryId) {
            console.log('Loading products for subcategory:', subcategoryId);
            
            showLoadingState();
            
            try {
                const response = await fetch(`/api/products/subcategory/${subcategoryId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load products: ' + response.status);
                }
                
                const products = await response.json();
                console.log('Loaded products for subcategory', subcategoryId + ':', products);
                console.log('Products array length:', products ? products.length : 'undefined');
                
                renderProductsGrid(products);
                
            } catch (error) {
                console.error('Error loading products:', error);
                showErrorState();
            }
        }

        // Render products grid
        function renderProductsGrid(products) {
            const productsGrid = document.getElementById('productsGrid');
            const productCountBadge = document.getElementById('productCountBadge');
            const productCount = document.getElementById('productCount');
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            
            console.log('Rendering products grid with', products ? products.length : 0, 'products');
            
            // Hide loading state
            if (loadingProducts) {
                loadingProducts.style.display = 'none';
            }
            
            if (!products || products.length === 0) {
                console.log('No products found, showing empty state');
                
                // Hide products grid and show empty state
                if (productsGrid) {
                    productsGrid.style.display = 'none';
                    productsGrid.innerHTML = ''; // Clear any existing products
                }
                if (emptyProducts) {
                    emptyProducts.style.display = 'block';
                }
                if (productCountBadge) {
                    productCountBadge.style.display = 'none';
                }
                return;
            }
            
            console.log('Products found, rendering grid');
            
            // Hide empty state and show products grid
            if (emptyProducts) {
                emptyProducts.style.display = 'none';
            }
            if (productsGrid) {
                productsGrid.style.display = 'grid';
            }
            
            // Show product count
            if (productCount) {
                productCount.textContent = products.length;
            }
            if (productCountBadge) {
                productCountBadge.style.display = 'flex';
            }
            
            // Generate products HTML
            const productsHtml = products.map(product => {
                const discountPercentage = calculateDiscountPercentage(product.originalPrice, product.price);
                const savings = product.originalPrice ? (product.originalPrice - product.price).toFixed(0) : 0;
                
                return `
                    <div class="blinkit-product-card" data-product-id="${product.id}" onclick="viewProductDetails(this.dataset.productId)">
                        <div class="product-image-container">
                            <img src="${product.imageUrl || 'https://cdn.grofers.com/cdn-cgi/image/f=auto,fit=scale-down,q=70,metadata=none,w=270/app/images/category/cms_images/icon/1487_1679466558536.png'}" 
                                 alt="${product.name}" 
                                 class="product-image"
                                 onerror="this.src='https://cdn.grofers.com/cdn-cgi/image/f=auto,fit=scale-down,q=70,metadata=none,w=270/app/images/category/cms_images/icon/1487_1679466558536.png'">
                            <div class="delivery-time-badge">
                                <i class="fas fa-clock"></i> 9 MINS
                            </div>
                            ${discountPercentage > 0 ? `<div class="discount-badge">${discountPercentage}% OFF</div>` : ''}
                        </div>
                        <div class="product-details">
                            <h3 class="product-name">${product.name}</h3>
                            <div class="product-weight">${product.unit || '1 piece'}</div>
                            <div class="product-pricing">
                                <span class="current-price">${product.price}</span>
                                ${product.originalPrice ? `<span class="original-price">${product.originalPrice}</span>` : ''}
                                ${savings > 0 ? `<span class="savings-amount">Save ${savings}</span>` : ''}
                            </div>
                            <button class="blinkit-add-button" 
                                    data-product-id="${product.id}" 
                                    data-product-name="${product.name.replace(/'/g, "\\'")}" 
                                    data-product-price="${product.price}"
                                    onclick="event.stopPropagation(); blinkitAddToCart(this.dataset.productId, this.dataset.productName, this.dataset.productPrice)">
                                ADD
                            </button>
                            <div class="product-quantity-controls" id="qty-controls-${product.id}">
                                <button class="product-qty-btn" 
                                        data-product-id="${product.id}"
                                        onclick="event.stopPropagation(); updateProductQuantity(this.dataset.productId, -1)"></button>
                                <span class="product-qty-value" id="qty-value-${product.id}">1</span>
                                <button class="product-qty-btn" 
                                        data-product-id="${product.id}"
                                        onclick="event.stopPropagation(); updateProductQuantity(this.dataset.productId, 1)">+</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Set products HTML with null check
            if (productsGrid) {
                productsGrid.innerHTML = productsHtml;
            } else {
                console.error('Products grid element not found in DOM');
                return;
            }
            
            // Update product card states based on cart
            updateProductCardStates();
            
            console.log('Rendered', products.length, 'products');
        }

        // Calculate discount percentage
        function calculateDiscountPercentage(originalPrice, currentPrice) {
            if (!originalPrice || originalPrice <= currentPrice) return 0;
            return Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
        }

        // Show loading state
        function showLoadingState() {
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            const productsGrid = document.getElementById('productsGrid');
            
            console.log('Showing loading state');
            
            if (loadingProducts) {
                loadingProducts.style.display = 'grid';
            }
            if (emptyProducts) {
                emptyProducts.style.display = 'none';
            }
            if (productsGrid) {
                productsGrid.style.display = 'none';
                productsGrid.innerHTML = ''; // Clear any existing products
            }
        }

        // Show empty state
        function showEmptyState() {
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            const productCountBadge = document.getElementById('productCountBadge');
            const productsGrid = document.getElementById('productsGrid');
            
            console.log('Showing empty state');
            
            if (loadingProducts) {
                loadingProducts.style.display = 'none';
            }
            if (emptyProducts) {
                emptyProducts.style.display = 'block';
            }
            if (productCountBadge) {
                productCountBadge.style.display = 'none';
            }
            if (productsGrid) {
                productsGrid.style.display = 'none';
                productsGrid.innerHTML = ''; // Clear any existing products
            }
        }

        // Show error state
        function showErrorState() {
            const productsGrid = document.getElementById('productsGrid');
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div class="empty-products">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Products</h3>
                        <p>Something went wrong while loading products. Please try again.</p>
                        <button onclick="loadProductsBySubcategory(currentSubcategoryId)" 
                                class="cart-btn cart-btn-primary" style="margin-top: 16px;">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            } else {
                console.error('Products grid element not found in DOM');
            }
        }

        // View product details
        function viewProductDetails(productId) {
            console.log('Viewing product details:', productId);
            window.location.href = `/products/${productId}`;
        }

        // Cart Storage Key
        const CART_STORAGE_KEY = 'blinkit_cart';

        // Get cart from localStorage
        function getCart() {
            try {
                return JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || {};
            } catch (error) {
                console.error('Error parsing cart from localStorage:', error);
                return {};
            }
        }

        // Save cart to localStorage
        function saveCart(cart) {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
        }

        // Blinkit-style add to cart function
        function blinkitAddToCart(productId, productName, productPrice) {
            const cart = getCart();
            
            if (cart[productId]) {
                cart[productId].quantity += 1;
            } else {
                cart[productId] = {
                    id: productId,
                    name: productName,
                    price: parseFloat(productPrice),
                    quantity: 1
                };
            }
            
            saveCart(cart);
            updateBlinkitCartDisplay();
            updateProductCardState(productId);
            
            // Show feedback
            showBlinkitCartFeedback('Item added to cart!');
        }

        // Update product quantity
        function updateProductQuantity(productId, change) {
            const cart = getCart();
            
            if (cart[productId]) {
                cart[productId].quantity += change;
                
                if (cart[productId].quantity <= 0) {
                    delete cart[productId];
                } else {
                    cart[productId].quantity = Math.max(1, cart[productId].quantity);
                }
                
                saveCart(cart);
                updateBlinkitCartDisplay();
                updateProductCardState(productId);
            }
        }

        // Update product card states based on cart
        function updateProductCardStates() {
            const cart = getCart();
            
            // Update cards that are in cart
            Object.keys(cart).forEach(productId => {
                updateProductCardState(productId);
            });
        }
        
        // Update single product card state based on cart
        function updateProductCardState(productId) {
            const cart = getCart();
            const productCard = document.querySelector(`[onclick*="blinkitAddToCart('${productId}'"]`);
            if (!productCard) return;

            const addButton = productCard.querySelector('.blinkit-add-button');
            const qtyControls = productCard.querySelector('.product-quantity-controls');
            const qtyValue = productCard.querySelector('.product-qty-value');

            if (cart[productId] && cart[productId].quantity > 0) {
                // Show quantity controls, hide add button
                if (addButton) addButton.style.display = 'none';
                if (qtyControls) qtyControls.classList.add('show');
                if (qtyValue) qtyValue.textContent = cart[productId].quantity;
            } else {
                // Show add button, hide quantity controls
                if (addButton) addButton.style.display = 'block';
                if (qtyControls) qtyControls.classList.remove('show');
            }
        }

        // Update Blinkit cart display
        function updateBlinkitCartDisplay() {
            const cart = getCart();
            const cartItems = Object.values(cart);
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Update cart button text
            const cartText = document.getElementById('cartText');
            if (cartText) {
                cartText.textContent = `${totalItems} items  ${totalPrice.toFixed(0)} View Cart`;
            }
            
            // Update cart badge
            const cartBadge = document.getElementById('cartBadge');
            if (cartBadge) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        // Show cart feedback
        function showBlinkitCartFeedback(message) {
            // Simple console log for now - can be enhanced with toast notifications
            console.log('Cart feedback:', message);
        }
    </script>
</body>
</html>